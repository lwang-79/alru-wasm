import {
  createSignal,
  Show,
  For,
  onCleanup,
  createEffect,
  onMount,
} from "solid-js";
import type { AmplifyJobDetails } from "../services/aws/amplifyService";
import {
  appState,
  setAppState,
  checkAndResetPushStepIfNeeded,
  updatePushStepContext,
} from "../store/appStore";
import { WebContainerService } from "../services/container/webContainerService";
import { GitService, type GitCredentials } from "../services/git/gitService";
import { AmplifyService } from "../services/aws/amplifyService";
import { CredentialService } from "../services/aws/credentialService";
import { WizardStep } from "./common/WizardStep";
import { OperationCard } from "./common/OperationCard";
import { OperationFeedback } from "./common/OperationFeedback";
import "./shared-tailwind.css";

interface PushStepProps {
  onComplete?: () => void;
  onBack?: () => void;
}

export function PushStep(props: PushStepProps) {
  // Use store state instead of local signals for persistence
  const pushStatus = () => appState.pushStep.status;
  const setPushStatus = (status: typeof appState.pushStep.status) =>
    setAppState("pushStep", "status", status);

  const deploymentMode = () => appState.pushStep.deploymentMode;
  const setDeploymentMode = (mode: "current" | "test") =>
    setAppState("pushStep", "deploymentMode", mode);

  const pushError = () => appState.pushStep.error;
  const setPushError = (error: string | null) =>
    setAppState("pushStep", "error", error);

  const commitHash = () => appState.pushStep.commitHash;
  const setCommitHash = (hash: string | null) =>
    setAppState("pushStep", "commitHash", hash);

  const targetBranch = () => appState.pushStep.targetBranch;
  const setTargetBranch = (branch: string | null) =>
    setAppState("pushStep", "targetBranch", branch);

  const amplifyJob = () => appState.pushStep.amplifyJob;
  const setAmplifyJob = (job: AmplifyJobDetails | null) =>
    setAppState("pushStep", "amplifyJob", job);

  const jobCheckError = () => appState.pushStep.jobCheckError;
  const setJobCheckError = (error: string | null) =>
    setAppState("pushStep", "jobCheckError", error);

  // Add state to track when we're checking for jobs with retries
  const [checkingForJob, setCheckingForJob] = createSignal(false);

  const lastFailedJob = () => appState.pushStep.lastFailedJob;
  const setLastFailedJob = (job: AmplifyJobDetails | null) =>
    setAppState("pushStep", "lastFailedJob", job);

  const innerStep = () => appState.pushStep.innerStep;
  const setInnerStep = (step: number) =>
    setAppState("pushStep", "innerStep", step);

  const postTestSelection = () => appState.pushStep.postTestSelection;
  const setPostTestSelection = (selection: "push" | "manual" | null) =>
    setAppState("pushStep", "postTestSelection", selection);

  const retryingJob = () => appState.pushStep.retryingJob;
  const setRetryingJob = (retrying: boolean) =>
    setAppState("pushStep", "retryingJob", retrying);

  const [managementStatus, setManagementStatus] = createSignal<string | null>(
    null,
  );
  const [managementLoading, setManagementLoading] = createSignal(false);

  // Local signals for dialogs and temporary state (these don't need persistence)
  const [showCleanupDialog, setShowCleanupDialog] = createSignal(false);
  let jobCheckInterval: number | null = null;

  // Git credentials (will prompt user if needed)
  const [gitCredentials, setGitCredentials] =
    createSignal<GitCredentials | null>(null);

  // Environment variable revert functionality (local state)
  const [showRevertDialog, setShowRevertDialog] = createSignal(false);
  const [revertInProgress, setRevertInProgress] = createSignal(false);

  // Build spec revert functionality (local state)
  const [showBuildSpecRevertDialog, setShowBuildSpecRevertDialog] =
    createSignal(false);
  const [revertBuildSpecInProgress, setRevertBuildSpecInProgress] =
    createSignal(false);

  // Check if state should be reset on mount and when navigating to this step
  onMount(() => {
    checkAndResetPushStepIfNeeded();
    updatePushStepContext();
  });

  // Get environment variable changes from app state
  const getEnvVarChanges = () => appState.repository.envVarChanges;

  // Show confirmation dialog or start push immediately for test branch
  const handleInitiatePush = () => {
    if (deploymentMode() === "test") {
      // Skip confirmation for test branches
      handleConfirmPush();
    } else {
      setPushStatus("confirming");
    }
  };

  // Cancel push
  const handleCancelPush = () => {
    setPushStatus("pending");
  };

  // Get Git credentials - try stored credentials first, then prompt if needed
  const getStoredGitCredentials = async (): Promise<GitCredentials | null> => {
    try {
      const credentialService = new CredentialService();
      const storedCreds = credentialService.getGitCredentials();

      if (storedCreds && storedCreds.username && storedCreds.token) {
        console.log(
          "[getStoredGitCredentials] Found credentials for:",
          storedCreds.username,
        );
        // Map 'token' from storage to 'password' expected by GitService
        return {
          username: storedCreds.username,
          password: storedCreds.token, // token from storage -> password for git
        };
      }
      console.log(
        "[getStoredGitCredentials] No valid credentials found in storage",
      );
      return null;
    } catch (e) {
      console.error("Failed to load stored Git credentials:", e);
      return null;
    }
  };

  // Prompt for Git credentials as fallback
  const promptForGitCredentials = (): Promise<GitCredentials> => {
    return new Promise((resolve, reject) => {
      const username = prompt(
        "GitHub Authentication Required\n\n" +
        "No credentials found. Please configure credentials in Step 1.\n\n" +
        "Enter your GitHub username:",
      );
      if (!username) {
        reject(
          new Error(
            "GitHub username is required. Please go back to Step 1 to configure credentials.",
          ),
        );
        return;
      }

      const password = prompt(
        "GitHub Authentication Required\n\n" +
        "No credentials found. Please configure credentials in Step 1.\n\n" +
        "Enter your Personal Access Token (PAT):\n\n" +
        "Create one at: https://github.com/settings/tokens\n" +
        "Required scope: 'repo' (for private repos) or 'public_repo' (for public repos)",
      );
      if (!password) {
        reject(
          new Error(
            "Personal Access Token is required. Please go back to Step 1 to configure credentials.",
          ),
        );
        return;
      }

      resolve({ username, password });
    });
  };

  // Confirm and execute push
  const handleConfirmPush = async () => {
    const clonePath = appState.repository.clonePath;

    if (!clonePath) {
      setPushError("No repository path found");
      setPushStatus("failed");
      return;
    }

    setPushStatus("running");
    setPushError(null);
    setCommitHash(null);

    try {
      // Get WebContainer instance
      const container = await WebContainerService.getInstance();
      const gitService = new GitService(container);

      // Try to get stored Git credentials first
      let creds = gitCredentials();
      console.log("[Push] Initial gitCredentials state:", creds);

      if (!creds) {
        // Try loading from credential service
        console.log(
          "[Push] Attempting to load credentials from CredentialService...",
        );
        creds = await getStoredGitCredentials();
        console.log(
          "[Push] Loaded credentials:",
          creds
            ? `username: ${creds.username}, password: ${creds.password ? "[SET]" : "[MISSING]"}`
            : "null",
        );

        if (creds) {
          console.log("[Push] Using stored Git credentials from Step 1");
          setGitCredentials(creds);
        }
      }

      // If still no credentials, prompt the user
      if (!creds) {
        try {
          console.log("[Push] No stored credentials found, prompting user");
          creds = await promptForGitCredentials();
          console.log(
            "[Push] User provided credentials:",
            creds
              ? `username: ${creds.username}, password: ${creds.password ? "[SET]" : "[MISSING]"}`
              : "null",
          );
          setGitCredentials(creds);
        } catch (e) {
          setPushError(String(e));
          setPushStatus("failed");
          return;
        }
      }

      // Final validation before proceeding
      if (!creds || !creds.username || !creds.password) {
        console.error("[Push] Invalid credentials after all attempts:", creds);
        setPushError(
          "Invalid Git credentials. Please ensure both username and password/token are provided. " +
          "Go back to Step 1 to configure your GitHub credentials.",
        );
        setPushStatus("failed");
        return;
      }

      console.log(
        "[Push] Final credentials check passed. Username:",
        creds.username,
      );

      const currentBranch = appState.amplifyResources.selectedBranch?.branch_name;
      let targetBranch = currentBranch;
      setTargetBranch(targetBranch || null);

      if (deploymentMode() === "test" && currentBranch) {
        const credsDetails = new CredentialService().getCredentials();
        const username = credsDetails?.git?.username || "user";
        const timestamp = Math.floor(Date.now() / 1000);
        targetBranch = `test-${username}-${timestamp}`;

        console.log(`[Push] Target branch: ${targetBranch}`);
        setTargetBranch(targetBranch || null);

        console.log(`[Push] Creating test branch: ${targetBranch}...`);
        await gitService.createBranch(clonePath, targetBranch);
        await gitService.checkout(clonePath, targetBranch);
      }

      // Create commit message based on changes
      const targetRuntime = appState.runtimeInfo.targetRuntime;
      const backendType = appState.repository.backendType;
      const commitMessage = `chore: Update Lambda runtime to ${targetRuntime}

- Updated ${backendType} backend runtime configurations
- Upgraded Amplify packages to latest versions
${appState.repository.changes.length > 0 ? `- Modified ${appState.repository.changes.length} file(s)` : ""}

This update ensures Lambda functions use supported Node.js runtimes.`;

      // Check if there are any changes to commit
      console.log("[Push] Step 1: Checking for changed files...");
      let changedFiles;
      try {
        changedFiles = await gitService.getChangedFiles(clonePath);
        console.log("[Push] Changed files count:", changedFiles.length);
        console.log("[Push] Changed files:", changedFiles);
      } catch (getChangedFilesError) {
        console.error(
          "[Push] ERROR getting changed files:",
          getChangedFilesError,
        );
        throw getChangedFilesError;
      }

      let hash;
      if (changedFiles.length === 0) {
        if (deploymentMode() === "test" && targetBranch && targetBranch !== currentBranch) {
          // Push the branch ref even if there are no changes to commit
          console.log("[Push] No changes detected, but pushing new branch anyway...");
          await gitService.push(clonePath, creds, (message: string) => {
            console.log(`[Git Progress] ${message}`);
          }, targetBranch);

          hash = await gitService.getCurrentCommit(clonePath);
          console.log("[Push] Pushed branch ref, hash:", hash);
        } else {
          // No changes to commit
          console.log("[Push] No changes to commit, skipping");
          setCommitHash(null);
          setPushStatus("success");
          setJobCheckError(
            "No changes were committed, so no deployment job was triggered",
          );

          // Check if the last job failed - if so, we should retry it
          checkLastJobStatus();
          return;
        }
      } else {
        // Commit and push changes with streaming progress
        console.log("[Push] Step 2: Starting commitAndPush...");
        try {
          hash = await gitService.commitAndPush(
            clonePath,
            commitMessage,
            creds,
            (message: string) => {
              // Progress callback for streaming updates
              console.log(`[Git Progress] ${message}`);
            },
            targetBranch || undefined,
          );
          console.log("[Push] Step 3: commitAndPush SUCCESS, hash:", hash);
        } catch (commitPushError) {
          console.error("[Push] ‚ùå ERROR in commitAndPush:");
          console.error("[Push] Error object:", commitPushError);
          console.error("[Push] Error type:", typeof commitPushError);
          if (commitPushError instanceof Error) {
            console.error("[Push] Error message:", commitPushError.message);
            console.error("[Push] Error stack:", commitPushError.stack);
          }
          throw commitPushError;
        }
      }

      setCommitHash(hash);
      setPushStatus("success");

      // Check for Amplify job
      if (hash) {
        // If we pushed to a test branch, we might need to wait and verify it's connected
        if (deploymentMode() === "test" && targetBranch && targetBranch !== currentBranch) {
          console.log("[Push] Waiting 5 seconds for Amplify to detect new branch...");
          await new Promise((resolve) => setTimeout(resolve, 5000));

          const amplifyService = new AmplifyService();
          const region = appState.awsConfig.selectedRegion;
          const appId = appState.amplifyResources.selectedApp?.app_id;

          if (region && appId) {
            try {
              const branches = await amplifyService.listBranches(region, appId);
              const branchExists = branches.some((b) => b.branchName === targetBranch);

              if (!branchExists) {
                console.log(`[Push] Branch ${targetBranch} not found in Amplify, connecting it now...`);
                await amplifyService.createBranch(region, appId, targetBranch, `Test branch created via ALRU on ${new Date().toLocaleString()}`);
                console.log(`[Push] Branch ${targetBranch} connected successfully.`);

                // Manually start the job since auto-build might not trigger immediately on first connection
                try {
                  console.log(`[Push] Manually starting job for branch ${targetBranch}...`);
                  await amplifyService.startJob(region, appId, targetBranch, "RELEASE");
                  console.log(`[Push] Job started successfully for ${targetBranch}.`);
                } catch (startJobError) {
                  console.warn("[Push] Failed to manually start job (it might have started automatically):", startJobError);
                }

                // Wait a bit more for the job to show up in the list
                await new Promise((resolve) => setTimeout(resolve, 3000));
              }
            } catch (branchError) {
              console.error("[Push] Error verifying/connecting branch:", branchError);
            }
          }
        }

        checkForAmplifyJob(hash, targetBranch || undefined);
      }
    } catch (e) {
      const errorMessage = String(e);

      // Check if it's an authentication error
      if (
        errorMessage.includes("401") ||
        errorMessage.includes("403") ||
        errorMessage.includes("Invalid username or password") ||
        errorMessage.includes("authentication failed")
      ) {
        // Clear invalid credentials so user can re-enter
        setGitCredentials(null);
        setPushError(
          "Authentication failed. Please check your GitHub username and Personal Access Token (PAT). " +
          "Make sure your PAT has 'repo' permissions.",
        );
      } else {
        setPushError(errorMessage);
      }

      setPushStatus("failed");
    }
  };

  // Check the last job status to see if we should offer a retry
  const checkLastJobStatus = async () => {
    console.log("[checkLastJobStatus] Starting to check last job status");
    const selectedApp = appState.amplifyResources.selectedApp;
    const selectedBranch = appState.amplifyResources.selectedBranch;
    const region = appState.awsConfig.selectedRegion;

    console.log(
      "[checkLastJobStatus] App:",
      selectedApp?.name,
      "Branch:",
      selectedBranch?.branch_name,
    );

    if (!selectedApp || !selectedBranch || !region) {
      console.log("[checkLastJobStatus] Missing required info, aborting");
      return;
    }

    try {
      console.log("[checkLastJobStatus] Fetching jobs from Amplify...");
      const amplifyService = new AmplifyService();

      // Get the latest job for this branch
      const jobs = await amplifyService.listJobs(
        region,
        selectedApp.app_id,
        selectedBranch.branch_name,
      );

      if (jobs.length > 0) {
        // Get the most recent job details
        const latestJobId = jobs[0].jobId;
        const lastJob = await amplifyService.getJob(
          region,
          selectedApp.app_id,
          selectedBranch.branch_name,
          latestJobId,
        );

        console.log("[checkLastJobStatus] Last job result:", lastJob);
        console.log("[checkLastJobStatus] Last job status:", lastJob.status);

        // Set lastFailedJob for both FAILED and SUCCEED status
        // FAILED: deployment failed, need to retry
        // SUCCEED: functions might have been updated outside Amplify, need to redeploy
        if (lastJob.status === "FAILED" || lastJob.status === "SUCCEED") {
          console.log("[checkLastJobStatus] Setting lastFailedJob:", lastJob);
          setLastFailedJob(lastJob);
        } else {
          console.log(
            "[checkLastJobStatus] Last job status is not FAILED or SUCCEED, it's:",
            lastJob.status,
          );
        }
      } else {
        console.log("[checkLastJobStatus] No jobs found");
      }
    } catch (e) {
      console.error("[checkLastJobStatus] Failed to check last job status:", e);
    }
  };

  // Retry the last failed job
  const handleRetryJob = async () => {
    const lastJob = lastFailedJob();
    if (!lastJob) return;

    const selectedApp = appState.amplifyResources.selectedApp;
    const selectedBranch = appState.amplifyResources.selectedBranch;
    const region = appState.awsConfig.selectedRegion;

    if (!selectedApp || !selectedBranch || !region) {
      return;
    }

    setRetryingJob(true);

    try {
      const amplifyService = new AmplifyService();

      // Start a RETRY job
      const newJob = await amplifyService.startJob(
        region,
        selectedApp.app_id,
        selectedBranch.branch_name,
        "RETRY",
        lastJob.jobId,
      );

      setAmplifyJob(newJob);
      setJobCheckError(null);
      setLastFailedJob(null);

      // Start polling for job status updates
      startJobStatusPolling(newJob.jobId, selectedBranch.branch_name);
    } catch (e) {
      console.error("Failed to retry job:", e);
      setJobCheckError(`Failed to retry job: ${String(e)}`);
    } finally {
      setRetryingJob(false);
    }
  };

  // Check for Amplify job after push with retry logic
  const checkForAmplifyJob = async (commitId: string, branchOverride?: string) => {
    const selectedApp = appState.amplifyResources.selectedApp;
    const selectedBranch = appState.amplifyResources.selectedBranch;
    const region = appState.awsConfig.selectedRegion;

    if (!selectedApp || (!selectedBranch && !branchOverride) || !region) {
      return;
    }

    const branchName = branchOverride || selectedBranch!.branch_name;

    setCheckingForJob(true);
    setJobCheckError(null);

    const maxRetries = 3;
    const retryDelays = [5000, 10000, 15000]; // 5s, 10s, 15s for attempts 1, 2, 3

    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        // Wait before each attempt (including the first one)
        const currentDelay = retryDelays[attempt - 1];
        console.log(
          `[checkForAmplifyJob] Waiting ${currentDelay}ms before attempt ${attempt}/${maxRetries}...`,
        );

        // Update UI to show waiting status
        setJobCheckError(
          `Waiting ${currentDelay / 1000}s before checking for deployment job... (attempt ${attempt}/${maxRetries})`,
        );

        await new Promise((resolve) => setTimeout(resolve, currentDelay));

        console.log(
          `[checkForAmplifyJob] Attempt ${attempt}/${maxRetries}: Looking for job with commit ${commitId}...`,
        );

        // Update UI to show we're now checking
        setJobCheckError(
          `Looking for deployment job... (attempt ${attempt}/${maxRetries})`,
        );

        const amplifyService = new AmplifyService();
        // Fetch jobs without filtering by commitId first to handle "HEAD" or multiple matches
        const jobs = await amplifyService.listJobs(
          region,
          selectedApp.app_id,
          branchName,
        );

        // Find the best matching job:
        // 1. Exact commitId match
        // 2. "HEAD" match (common for new branches/manual starts)
        // 3. Any active job if it's a test branch (since we just started it)
        const job = jobs.find(j => j.commitId === commitId) ||
          jobs.find(j => j.commitId === "HEAD") ||
          (deploymentMode() === "test" ? jobs[0] : null);

        if (job) {
          // Found a job, get its details
          console.log(
            `[checkForAmplifyJob] Found job (${job.commitId}) on attempt ${attempt}:`,
            job.jobId,
          );

          const jobDetails = await amplifyService.getJob(
            region,
            selectedApp.app_id,
            branchName,
            job.jobId,
          );

          setAmplifyJob(jobDetails);
          setJobCheckError(null);
          setCheckingForJob(false);

          // Start polling for job status updates every 10 seconds
          startJobStatusPolling(job.jobId, branchName);
          return; // Job found, exit retry loop
        } else {
          console.log(
            `[checkForAmplifyJob] No job found on attempt ${attempt}/${maxRetries}`,
          );

          // If this is the last attempt, show final error message
          if (attempt === maxRetries) {
            console.log("[checkForAmplifyJob] No job found after all retries");
            setJobCheckError(
              "No Amplify job found for this commit after multiple attempts. The job may take longer to appear.",
            );
          }
        }
      } catch (e) {
        console.error(`[checkForAmplifyJob] Attempt ${attempt} failed:`, e);

        // If this is the last attempt, show error
        if (attempt === maxRetries) {
          console.error("[checkForAmplifyJob] All retry attempts failed:", e);
          setJobCheckError(String(e));
        }
      }
    }

    setCheckingForJob(false);
  };

  // Poll job status every 10 seconds
  const startJobStatusPolling = (jobId: string, branchName: string) => {
    // Clear any existing interval
    if (jobCheckInterval !== null) {
      clearInterval(jobCheckInterval);
    }

    jobCheckInterval = window.setInterval(async () => {
      const selectedApp = appState.amplifyResources.selectedApp;
      const region = appState.awsConfig.selectedRegion;

      if (!selectedApp || !region) {
        return;
      }

      try {
        const amplifyService = new AmplifyService();
        const jobDetails = await amplifyService.getJob(
          region,
          selectedApp.app_id,
          branchName,
          jobId,
        );

        setAmplifyJob(jobDetails);

        // Stop polling if job is in a terminal state
        if (["SUCCEED", "FAILED", "CANCELLED"].includes(jobDetails.status)) {
          if (jobCheckInterval !== null) {
            clearInterval(jobCheckInterval);
            jobCheckInterval = null;
          }
        }
      } catch (e) {
        console.error("Failed to update job status:", e);
      }
    }, 10000); // 10 seconds
  };

  // Cleanup interval on component unmount
  onCleanup(() => {
    if (jobCheckInterval !== null) {
      clearInterval(jobCheckInterval);
    }
  });

  // Debug: Log when lastFailedJob changes
  createEffect(() => {
    const job = lastFailedJob();
    console.log("[createEffect] lastFailedJob changed:", job);
  });

  // Revert environment variables (excluding _LIVE_UPDATES and _CUSTOM_IMAGE)
  const handleRevertEnvVars = async () => {
    const changes = getEnvVarChanges();
    const revertableChanges = changes.filter(
      (change) =>
        change.key !== "_LIVE_UPDATES" && change.key !== "_CUSTOM_IMAGE",
    );

    if (revertableChanges.length === 0) {
      return;
    }

    setRevertInProgress(true);

    try {
      const selectedApp = appState.amplifyResources.selectedApp;
      const selectedBranch = appState.amplifyResources.selectedBranch;
      const region = appState.awsConfig.selectedRegion;

      if (!selectedApp || !selectedBranch || !region) {
        throw new Error(
          "Missing required information for environment variable revert",
        );
      }

      const amplifyService = new AmplifyService();

      // Group changes by level (app vs branch)
      const appChanges = revertableChanges.filter((c) => c.level === "app");
      const branchChanges = revertableChanges.filter(
        (c) => c.level === "branch",
      );

      // Revert app-level changes
      if (appChanges.length > 0) {
        // Step 1: Get CURRENT environment variables from AWS (not from stale app state)
        const app = await amplifyService.getApp(region, selectedApp.app_id);
        const currentAppEnvVars = { ...app.environmentVariables };

        // Step 2: Replace only the revertable variables with their old values
        // Keep everything else unchanged (including _LIVE_UPDATES and _CUSTOM_IMAGE)
        for (const change of appChanges) {
          currentAppEnvVars[change.key] = change.old_value;
        }

        // Step 3: Update AWS with the modified environment variables
        await amplifyService.updateAppEnvironmentVariables(
          region,
          selectedApp.app_id,
          currentAppEnvVars,
        );
      }

      // Revert branch-level changes
      if (branchChanges.length > 0) {
        // Step 1: Get CURRENT environment variables from AWS (not from stale app state)
        const branch = await amplifyService.getBranch(
          region,
          selectedApp.app_id,
          selectedBranch.branch_name,
        );
        const currentBranchEnvVars = { ...branch.environmentVariables };

        // Step 2: Replace only the revertable variables with their old values
        // Keep everything else unchanged (including _LIVE_UPDATES and _CUSTOM_IMAGE)
        for (const change of branchChanges) {
          currentBranchEnvVars[change.key] = change.old_value;
        }

        // Step 3: Update AWS with the modified environment variables
        await amplifyService.updateBranchEnvironmentVariables(
          region,
          selectedApp.app_id,
          selectedBranch.branch_name,
          currentBranchEnvVars,
        );
      }

      // Clear only the reverted changes from state, keep non-revertible ones
      const remainingChanges = getEnvVarChanges().filter(
        (change) =>
          change.key === "_LIVE_UPDATES" || change.key === "_CUSTOM_IMAGE",
      );
      setAppState("repository", "envVarChanges", remainingChanges);
      setShowRevertDialog(false);
    } catch (e) {
      console.error("Failed to revert environment variables:", e);
      // Could add error state here if needed
    } finally {
      setRevertInProgress(false);
    }
  };

  const handleCancelRevert = () => {
    setShowRevertDialog(false);
  };

  // Revert build spec to original
  const handleRevertBuildSpec = async () => {
    const originalBuildSpec = appState.repository.originalBuildSpec;

    if (!originalBuildSpec) {
      console.error("No original build spec found");
      return;
    }

    setRevertBuildSpecInProgress(true);

    try {
      const selectedApp = appState.amplifyResources.selectedApp;
      const region = appState.awsConfig.selectedRegion;

      if (!selectedApp || !region) {
        throw new Error("Missing required information for build spec revert");
      }

      const amplifyService = new AmplifyService();

      // Revert the build spec by updating the app with the original build spec
      await amplifyService.revertBuildSpec(
        region,
        selectedApp.app_id,
        originalBuildSpec,
      );

      // Clear build config change and original build spec from state
      setAppState("repository", "buildConfigChange", null);
      setAppState("repository", "originalBuildSpec", null);
      setShowBuildSpecRevertDialog(false);
    } catch (e) {
      console.error("Failed to revert build spec:", e);
      // Could add error state here if needed
    } finally {
      setRevertBuildSpecInProgress(false);
    }
  };

  const handleCancelBuildSpecRevert = () => {
    setShowBuildSpecRevertDialog(false);
  };

  // Helper function to format dates with unambiguous month names
  const formatLocalDateTime = (dateString: string) => {
    const date = new Date(dateString);

    return date.toLocaleString("en-US", {
      year: "numeric",
      month: "short", // This gives us "Jan", "Feb", "Mar", etc.
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: true,
    });
  };

  const handleBack = () => {
    // Disable back if push is running or finished
    if (pushStatus() === "running" || pushStatus() === "success") {
      return;
    }
    if (props.onBack) props.onBack();
  };

  const handleCleanupClose = () => {
    setShowCleanupDialog(false);
    // Don't call props.onComplete() after cleanup since cleanup resets the state
    // The CleanupDialog already handles navigation to the appropriate step
  };

  // Push the same changes to the current main branch
  const handlePushToCurrent = async () => {
    const creds = await getStoredGitCredentials();
    if (!creds) {
      setManagementStatus("Error: Git credentials not found in storage. Please go back to Step 1.");
      return;
    }

    const currentBranch = appState.amplifyResources.selectedBranch?.branch_name;
    const clonePath = appState.repository.clonePath;

    if (!currentBranch || !clonePath) {
      setManagementStatus("Error: Target branch or repository path missing.");
      return;
    }

    setManagementLoading(true);
    setManagementStatus("Pushing changes to current branch...");

    try {
      const container = await WebContainerService.getInstance();
      const gitService = new GitService(container);

      // Checkout the current branch first
      setManagementStatus(`Checking out ${currentBranch}...`);
      await gitService.checkout(clonePath, currentBranch);

      // Merge the test branch into current branch
      const testBranch = targetBranch();
      if (testBranch) {
        setManagementStatus(`Merging ${testBranch} into ${currentBranch}...`);
        await gitService.merge(clonePath, testBranch);
      }

      // Push to remote
      setManagementStatus(`Pushing to remote ${currentBranch}...`);
      await gitService.push(clonePath, creds, (msg) => {
        console.log(`[Git Progress] ${msg}`);
        setManagementStatus(msg);
      }, currentBranch);

      setManagementStatus("Successfully pushed to current branch.");
    } catch (e) {
      console.error("[Post-Push] Error pushing to current branch:", e);
      setManagementStatus(`Error: Failed to push to current branch: ${String(e)}`);
    } finally {
      setManagementLoading(false);
    }
  };

  // Delete the test branch locally and in Amplify
  const handleDeleteTestBranch = async () => {
    const branchName = targetBranch();
    const region = appState.awsConfig.selectedRegion;
    const appId = appState.amplifyResources.selectedApp?.app_id;
    const clonePath = appState.repository.clonePath;
    const currentBranch = appState.amplifyResources.selectedBranch?.branch_name;

    if (!branchName || !region || !appId || !clonePath || !currentBranch) {
      setPushError("Missing information to delete branch.");
      return;
    }

    if (!confirm(`Are you sure you want to delete the test branch '${branchName}' locally, in remote repository, and in Amplify?`)) {
      return;
    }

    const creds = await getStoredGitCredentials();
    if (!creds) {
      setPushError("Git credentials not found in storage. Please go back to Step 1.");
      return;
    }

    setManagementLoading(true);
    setManagementStatus("Deleting test branch...");

    try {
      const container = await WebContainerService.getInstance();
      const amplifyService = new AmplifyService();
      const gitService = new GitService(container);

      // 1. Delete in Amplify
      setManagementStatus("Deleting branch in AWS Amplify...");
      await amplifyService.deleteBranch(region, appId, branchName);

      // 2. Delete Remote Branch
      setManagementStatus("Deleting branch from remote repository...");
      await gitService.deleteRemoteBranch(clonePath, creds, branchName, (msg) => {
        setManagementStatus(msg);
      });

      // 3. Checkout the original branch before deleting the current test branch locally
      setManagementStatus("Switching back to original branch...");
      await gitService.checkout(clonePath, currentBranch);

      // 4. Delete locally
      setManagementStatus("Deleting local branch...");
      await gitService.deleteBranch(clonePath, branchName);

      setManagementStatus("Test branch deleted successfully.");
      setTargetBranch(null);
      // We might want to reset deployment mode or stay on success
    } catch (e) {
      console.error("[Post-Push] Error deleting test branch:", e);
      setPushError(`Failed to delete branch: ${String(e)}`);
      setManagementStatus(null);
    } finally {
      setManagementLoading(false);
    }
  };

  const getStepTitle = () => "Deploy Changes";
  
  const getStepDescription = () => "Review and push your local runtime changes to AWS Amplify.";

  const handleFinishWizard = () => {
    // Show cleanup dialog if repository exists
    if (appState.repository.clonePath) {
      setShowCleanupDialog(true);
    } else if (props.onComplete) {
      props.onComplete();
    }
  };

  // Check if all steps are complete
  const canFinish = () => {
    if (deploymentMode() === "current") {
      // For current branch: just need successful push
      return pushStatus() === "success";
    } else {
      // For test branch: need all steps complete
      const jobComplete = amplifyJob() && ["SUCCEED", "FAILED", "CANCELLED"].includes(amplifyJob()!.status);
      
      if (!jobComplete) return false;
      
      // If user selected push to current, need that to be complete
      if (postTestSelection() === "push") {
        return managementStatus()?.includes("Successfully pushed to current branch");
      }
      
      // If manual merge selected, can finish after selection
      return postTestSelection() === "manual";
    }
  };

  return (
    <WizardStep
      title={getStepTitle()}
      description={getStepDescription()}
      onNext={handleFinishWizard}
      onBack={handleBack}
      nextDisabled={!canFinish()}
      backDisabled={pushStatus() === "running" || pushStatus() === "success"}
      isLoading={pushStatus() === "running" || managementLoading()}
      nextLabel="Finish"
      showNext={canFinish()}
    >
      <div class="space-y-6">
        {/* Summary Section */}
        <div class="bg-white dark:bg-[#2a2a2a] border border-[#e0e0e0] dark:border-[#444] rounded-lg p-6">
          <h3 class="text-lg font-semibold mb-4 text-[#333] dark:text-[#eee]">
            Changes Summary
          </h3>
          <div class="flex flex-wrap gap-x-4 gap-y-3 mb-3">
            <div class="flex-1 basis-[calc(50%-1rem)] min-w-[200px] flex items-center gap-2">
              <span class="font-medium text-[#666] dark:text-[#aaa] min-w-[120px]">
                App:
              </span>
              <span class="text-[#333] dark:text-[#eee]">
                {appState.amplifyResources.selectedApp?.name}
              </span>
            </div>
            <div class="flex-1 basis-[calc(50%-1rem)] min-w-[200px] flex items-center gap-2">
              <span class="font-medium text-[#666] dark:text-[#aaa] min-w-[120px]">
                Branch:
              </span>
              <span class="text-[#333] dark:text-[#eee]">
                {appState.amplifyResources.selectedBranch?.branch_name}
              </span>
            </div>
          </div>
          <div class="flex flex-wrap gap-x-4 gap-y-3 mb-3">
            <div class="flex-1 basis-[calc(50%-1rem)] min-w-[200px] flex items-center gap-2">
              <span class="font-medium text-[#666] dark:text-[#aaa] min-w-[120px]">
                Target Runtime:
              </span>
              <span class="px-3 py-1 bg-[#e0f2f1] text-[#00796b] dark:bg-[#1a2e2c] dark:text-[#4db6ac] rounded-md text-sm font-semibold font-mono">
                {appState.runtimeInfo.targetRuntime}
              </span>
            </div>
            <div class="flex-1 basis-[calc(50%-1rem)] min-w-[200px] flex items-center gap-2">
              <span class="font-medium text-[#666] dark:text-[#aaa] min-w-[120px]">
                Backend Type:
              </span>
              <span class="px-3 py-1 bg-[#e3f2fd] text-[#1976d2] dark:bg-[#1a2a3a] dark:text-[#64b5f6] rounded-md text-sm font-semibold">
                {appState.repository.backendType === "Gen2" ? "Gen 2" : "Gen 1"}
              </span>
            </div>
          </div>
          <div class="flex flex-wrap gap-x-4 gap-y-3">
            <div class="w-full flex items-center gap-2">
              <span class="font-medium text-[#666] dark:text-[#aaa] min-w-[120px]">
                Files Modified:
              </span>
              <span class="text-[#333] dark:text-[#eee]">
                {appState.repository.changes.length > 0
                  ? `${appState.repository.changes.length} file(s)`
                  : "No manual changes (updated via package upgrade)"}
              </span>
            </div>
          </div>
        </div>

        {/* Deployment Options */}
        <div class="bg-white dark:bg-[#2a2a2a] border border-[#e0e0e0] dark:border-[#444] rounded-lg p-6">
          <h3 class="text-lg font-semibold mb-4 text-[#333] dark:text-[#eee]">
            Deployment Options
          </h3>
          <div class="space-y-4">
            <label class="flex items-center gap-3 cursor-pointer group">
              <input
                type="radio"
                name="deploymentMode"
                value="current"
                checked={deploymentMode() === "current"}
                onChange={() => setDeploymentMode("current")}
                class="w-5 h-5 text-[#396cd8] border-gray-300 focus:ring-[#396cd8] cursor-pointer"
                disabled={pushStatus() === "running" || pushStatus() === "success"}
              />
              <div>
                <span class="block font-medium text-[#333] dark:text-[#eee] group-hover:text-[#396cd8] transition-colors">
                  Deploy to current branch ({appState.amplifyResources.selectedBranch?.branch_name})
                </span>
                <span class="text-sm text-[#666] dark:text-[#aaa]">
                  Push changes directly to the existing branch.
                </span>
              </div>
            </label>
            <label class="flex items-center gap-3 cursor-pointer group">
              <input
                type="radio"
                name="deploymentMode"
                value="test"
                checked={deploymentMode() === "test"}
                onChange={() => setDeploymentMode("test")}
                class="w-5 h-5 text-[#396cd8] border-gray-300 focus:ring-[#396cd8] cursor-pointer"
                disabled={pushStatus() === "running" || pushStatus() === "success"}
              />
              <div>
                <span class="block font-medium text-[#333] dark:text-[#eee] group-hover:text-[#396cd8] transition-colors">
                  Deploy to a new test branch
                </span>
                <span class="text-sm text-[#666] dark:text-[#aaa]">
                  Create a new temporary branch (test-username-timestamp) for this deployment.
                </span>
              </div>
            </label>
          </div>
        </div>

        {/* Step 1: Push Changes */}
        <OperationCard
          stepNumber={1}
          title="Push Changes"
          description={`Push changes to ${deploymentMode() === "test" ? "test branch" : "current branch"}`}
          status={pushStatus() === "pending" ? "pending" : pushStatus() === "confirming" ? "pending" : pushStatus() === "running" ? "running" : pushStatus() === "success" ? "success" : "failed"}
          onAction={handleInitiatePush}
          actionLabel="Push"
          runningLabel="Pushing..."
          successLabel="‚úì Pushed"
          failedLabel="‚úó Failed"
          error={pushError()}
        >
          <Show when={pushStatus() === "success"}>
            <OperationFeedback
              status="success"
              noChanges={!commitHash()}
              noChangesMessage={
                <div class="text-sm">
                  <Show when={!commitHash()}>
                    <p class="m-0 mb-2">No changes were committed. All runtime configurations were already up to date.</p>
                  </Show>
                  <Show when={commitHash()}>
                    <div class="flex items-center gap-2 mb-3">
                      <span class="text-[#666] dark:text-[#aaa]">Commit:</span>
                      <code class="font-mono text-xs bg-[#e0e0e0] dark:bg-[#444] px-2 py-1 rounded">
                        {commitHash()}
                      </code>
                    </div>
                  </Show>
                  <Show when={targetBranch()}>
                    <div class="flex items-center gap-2">
                      <span class="text-[#666] dark:text-[#aaa]">Branch:</span>
                      <code class="font-mono text-xs bg-[#e0e0e0] dark:bg-[#444] px-2 py-1 rounded">
                        {targetBranch()}
                      </code>
                    </div>
                  </Show>
                </div>
              }
            />
            
            {/* Amplify Job Status */}
            <Show when={amplifyJob()}>
              <div class="mt-4 p-4 bg-[#f8f9fa] dark:bg-[#333] rounded-lg border border-[#e9ecef] dark:border-[#444]">
                <h4 class="m-0 mb-3 text-[#495057] dark:text-[#eee] text-sm font-semibold">
                  Amplify Deployment Job
                </h4>
                <div class="flex flex-col gap-2 text-xs">
                  <div class="flex items-center gap-2">
                    <span class="font-medium text-[#6c757d] dark:text-[#aaa] min-w-[60px]">Job ID:</span>
                    <code class="font-mono bg-[#e0e0e0] dark:bg-[#444] px-2 py-0.5 rounded">
                      {amplifyJob()?.jobId}
                    </code>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="font-medium text-[#6c757d] dark:text-[#aaa] min-w-[60px]">Status:</span>
                    <span
                      class={`px-2 py-0.5 rounded text-xs font-semibold ${
                        amplifyJob()?.status === "SUCCEED"
                          ? "bg-[#d4edda] text-[#155724] dark:bg-[#1b3a24] dark:text-[#81c784]"
                          : amplifyJob()?.status === "FAILED"
                            ? "bg-[#f8d7da] text-[#721c24] dark:bg-[#4a1f1f] dark:text-[#e57373]"
                            : amplifyJob()?.status === "RUNNING"
                              ? "bg-[#d1ecf1] text-[#0c5460] dark:bg-[#1a2e3a] dark:text-[#7dd3fc]"
                              : "bg-[#e2e3e5] text-[#383d41] dark:bg-[#3a3a3a] dark:text-[#aaa]"
                      }`}
                    >
                      {amplifyJob()?.status}
                    </span>
                    <Show when={amplifyJob()?.status === "RUNNING"}>
                      <span class="w-3 h-3 border-2 border-[#e0f2fe] border-t-[#0ea5e9] rounded-full animate-spin"></span>
                    </Show>
                  </div>
                  <Show when={amplifyJob()?.startTime}>
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-[#6c757d] dark:text-[#aaa] min-w-[60px]">Started:</span>
                      <span class="text-[#495057] dark:text-[#eee]">
                        {formatLocalDateTime(amplifyJob()!.startTime!.toISOString())}
                      </span>
                    </div>
                  </Show>
                  <Show when={amplifyJob()?.endTime}>
                    <div class="flex items-center gap-2">
                      <span class="font-medium text-[#6c757d] dark:text-[#aaa] min-w-[60px]">Ended:</span>
                      <span class="text-[#495057] dark:text-[#eee]">
                        {formatLocalDateTime(amplifyJob()!.endTime!.toISOString())}
                      </span>
                    </div>
                  </Show>
                </div>
              </div>
            </Show>

            {/* Waiting for job message */}
            <Show when={deploymentMode() === "test" && amplifyJob() && !["SUCCEED", "FAILED", "CANCELLED"].includes(amplifyJob()!.status)}>
              <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded border border-blue-200 dark:border-blue-800 flex items-center gap-2 text-sm">
                <span class="w-4 h-4 border-2 border-blue-200 border-t-blue-500 rounded-full animate-spin"></span>
                <span class="text-blue-700 dark:text-blue-300">
                  Waiting for deployment to complete before showing next steps...
                </span>
              </div>
            </Show>
          </Show>
        </OperationCard>

        {/* Step 2: Merge Decision (only for test branch after job completes) */}
        <Show when={deploymentMode() === "test" && pushStatus() === "success" && amplifyJob() && ["SUCCEED", "FAILED", "CANCELLED"].includes(amplifyJob()!.status)}>
          <OperationCard
            stepNumber={2}
            title="Merge Decision"
            description="Choose how to merge your test deployment"
            status={postTestSelection() ? "success" : "pending"}
            onAction={() => {}}
            actionLabel=""
            hideAction={true}
          >
            <div class="space-y-3">
              <p class="text-sm text-[#666] dark:text-[#aaa] m-0 mb-4">
                Test branch <code class="px-2 py-0.5 bg-[#e0e0e0] dark:bg-[#444] rounded font-mono text-xs">{targetBranch()}</code> deployed successfully. 
                Choose how to proceed:
              </p>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <button
                  class={`p-4 rounded-lg border-2 text-left transition-all ${
                    postTestSelection() === "push"
                      ? "border-blue-500 bg-blue-50 dark:bg-blue-900/30"
                      : "border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:border-gray-300"
                  }`}
                  onClick={() => setPostTestSelection("push")}
                  disabled={!!postTestSelection()}
                >
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-lg">üöÄ</span>
                    <span class="font-semibold text-sm">Push to Current</span>
                  </div>
                  <p class="m-0 text-xs text-[#666] dark:text-[#aaa]">
                    Merge and push to {appState.amplifyResources.selectedBranch?.branch_name}
                  </p>
                </button>
                <button
                  class={`p-4 rounded-lg border-2 text-left transition-all ${
                    postTestSelection() === "manual"
                      ? "border-blue-500 bg-blue-50 dark:bg-blue-900/30"
                      : "border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:border-gray-300"
                  }`}
                  onClick={() => setPostTestSelection("manual")}
                  disabled={!!postTestSelection()}
                >
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-lg">üìù</span>
                    <span class="font-semibold text-sm">Manual Merge</span>
                  </div>
                  <p class="m-0 text-xs text-[#666] dark:text-[#aaa]">
                    Handle merge through Git provider
                  </p>
                </button>
              </div>
            </div>
          </OperationCard>
        </Show>

        {/* Step 3: Push to Current Branch (only if user selected "push") */}
        <Show when={postTestSelection() === "push"}>
          <OperationCard
            stepNumber={3}
            title="Push to Current Branch"
            description={`Merge and push to ${appState.amplifyResources.selectedBranch?.branch_name}`}
            status={
              managementStatus()?.includes("Successfully pushed to current branch")
                ? "success"
                : managementStatus()?.includes("Error")
                  ? "failed"
                  : managementLoading()
                    ? "running"
                    : "pending"
            }
            onAction={handlePushToCurrent}
            actionLabel="Push to Current"
            runningLabel="Pushing..."
            successLabel="‚úì Pushed"
            failedLabel="‚úó Failed"
            error={managementStatus()?.includes("Error") ? managementStatus() : null}
          >
            <Show when={managementStatus() && !managementStatus()?.includes("Error")}>
              <OperationFeedback
                status={managementStatus()?.includes("Successfully") ? "success" : "running"}
                message={managementStatus()}
              />
            </Show>
          </OperationCard>
        </Show>

        {/* Step 4: Branch Cleanup (only for test branch, after merge decision) */}
        <Show when={deploymentMode() === "test" && postTestSelection() && targetBranch()}>
          <OperationCard
            stepNumber={postTestSelection() === "push" ? 4 : 3}
            title="Branch Cleanup (Optional)"
            description="Delete the test branch"
            status="pending"
            onAction={handleDeleteTestBranch}
            actionLabel="Delete Test Branch"
            runningLabel="Deleting..."
            successLabel="‚úì Deleted"
            failedLabel="‚úó Failed"
            hideAction={managementStatus()?.includes("deleted successfully")}
          >
            <div class="text-sm">
              <p class="m-0 mb-3 text-[#666] dark:text-[#aaa]">
                Test branch <code class="px-2 py-0.5 bg-[#e0e0e0] dark:bg-[#444] rounded font-mono text-xs">{targetBranch()}</code> can be deleted from:
              </p>
              <ul class="m-0 pl-5 text-[#666] dark:text-[#aaa] space-y-1">
                <li>Local repository</li>
                <li>Remote repository</li>
                <li>AWS Amplify</li>
              </ul>
              <Show when={managementStatus()?.includes("deleted successfully")}>
                <div class="mt-3 p-2 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 text-xs rounded">
                  ‚úì Test branch deleted successfully
                </div>
              </Show>
              <Show when={managementLoading()}>
                <div class="mt-3 p-2 bg-blue-50 dark:bg-blue-900/20 rounded text-xs">
                  <pre class="m-0 font-mono text-blue-700 dark:text-blue-300 whitespace-pre-wrap">
                    {managementStatus()}
                  </pre>
                </div>
              </Show>
            </div>
          </OperationCard>
        </Show>
      </div>

      {/* Revert Environment Variables Dialog */}
      <Show when={showRevertDialog()}>
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-[1000]">
          <div class="bg-white dark:bg-[#2a2a2a] rounded-xl p-6 max-w-[500px] w-[90%] max-h-[80vh] overflow-y-auto shadow-2xl">
            <h3 class="m-0 mb-4 text-[#495057] dark:text-[#eee] text-xl font-semibold">
              Revert Environment Variables
            </h3>
            <p class="m-0 mb-4 text-[#6c757d] dark:text-[#aaa] leading-relaxed">
              Are you sure you want to revert the environment variable changes?
              This will restore the original values.
            </p>
            <div class="flex flex-col gap-2 mb-6 max-h-[200px] overflow-y-auto pr-1">
            <h3 class="text-lg font-semibold mb-4 text-[#333] dark:text-[#eee]">
              Changes Summary
            </h3>
            <div class="flex flex-wrap gap-x-4 gap-y-3 mb-3">
              <div class="flex-1 basis-[calc(50%-1rem)] min-w-[200px] flex items-center gap-2">
                <span class="font-medium text-[#666] dark:text-[#aaa] min-w-[120px]">
                  App:
                </span>
                <span class="text-[#333] dark:text-[#eee]">
                  {appState.amplifyResources.selectedApp?.name}
                </span>
              </div>
              <div class="flex-1 basis-[calc(50%-1rem)] min-w-[200px] flex items-center gap-2">
                <span class="font-medium text-[#666] dark:text-[#aaa] min-w-[120px]">
                  Branch:
                </span>
                <span class="text-[#333] dark:text-[#eee]">
                  {appState.amplifyResources.selectedBranch?.branch_name}
                </span>
              </div>
            </div>
            <div class="flex flex-wrap gap-x-4 gap-y-3 mb-3">
              <div class="flex-1 basis-[calc(50%-1rem)] min-w-[200px] flex items-center gap-2">
                <span class="font-medium text-[#666] dark:text-[#aaa] min-w-[120px]">
                  Target Runtime:
                </span>
                <span class="px-3 py-1 bg-[#e0f2f1] text-[#00796b] dark:bg-[#1a2e2c] dark:text-[#4db6ac] rounded-md text-sm font-semibold font-mono">
                  {appState.runtimeInfo.targetRuntime}
                </span>
              </div>
              <div class="flex-1 basis-[calc(50%-1rem)] min-w-[200px] flex items-center gap-2">
                <span class="font-medium text-[#666] dark:text-[#aaa] min-w-[120px]">
                  Backend Type:
                </span>
                <span class="px-3 py-1 bg-[#e3f2fd] text-[#1976d2] dark:bg-[#1a2a3a] dark:text-[#64b5f6] rounded-md text-sm font-semibold">
                  {appState.repository.backendType === "Gen2" ? "Gen 2" : "Gen 1"}
                </span>
              </div>
            </div>
            <div class="flex flex-wrap gap-x-4 gap-y-3">
              <div class="w-full flex items-center gap-2">
                <span class="font-medium text-[#666] dark:text-[#aaa] min-w-[120px]">
                  Files Modified:
                </span>
                <span class="text-[#333] dark:text-[#eee]">
                  {appState.repository.changes.length > 0
                    ? `${appState.repository.changes.length} file(s)`
                    : "No manual changes (updated via package upgrade)"}
                </span>
              </div>
            </div>
          </div>

          {/* Deployment Options */}
          <div class="bg-white dark:bg-[#2a2a2a] border border-[#e0e0e0] dark:border-[#444] rounded-lg p-6 mb-8">
            <h3 class="text-lg font-semibold mb-4 text-[#333] dark:text-[#eee]">
              Deployment Options
            </h3>
            <div class="space-y-4">
              <label class="flex items-center gap-3 cursor-pointer group">
                <input
                  type="radio"
                  name="deploymentMode"
                  value="current"
                  checked={deploymentMode() === "current"}
                  onChange={() => setDeploymentMode("current")}
                  class="w-5 h-5 text-[#396cd8] border-gray-300 focus:ring-[#396cd8] cursor-pointer"
                  disabled={pushStatus() === "running" || pushStatus() === "success"}
                />
                <div>
                  <span class="block font-medium text-[#333] dark:text-[#eee] group-hover:text-[#396cd8] transition-colors">
                    Deploy to current branch ({appState.amplifyResources.selectedBranch?.branch_name})
                  </span>
                  <span class="text-sm text-[#666] dark:text-[#aaa]">
                    Push changes directly to the existing branch.
                  </span>
                </div>
              </label>
              <label class="flex items-center gap-3 cursor-pointer group">
                <input
                  type="radio"
                  name="deploymentMode"
                  value="test"
                  checked={deploymentMode() === "test"}
                  onChange={() => setDeploymentMode("test")}
                  class="w-5 h-5 text-[#396cd8] border-gray-300 focus:ring-[#396cd8] cursor-pointer"
                  disabled={pushStatus() === "running" || pushStatus() === "success"}
                />
                <div>
                  <span class="block font-medium text-[#333] dark:text-[#eee] group-hover:text-[#396cd8] transition-colors">
                    Deploy to a new test branch
                  </span>
                  <span class="text-sm text-[#666] dark:text-[#aaa]">
                    Create a new temporary branch (test-username-timestamp) for this deployment.
                  </span>
                </div>
              </label>
            </div>
          </div>

          {/* Push Action Section */}
          <div class="bg-white dark:bg-[#2a2a2a] border border-[#e0e0e0] dark:border-[#444] rounded-lg p-8 mb-8 min-h-[300px] flex items-center justify-center">
            <Show when={pushStatus() === "pending"}>
              <div class="text-center max-w-[500px]">
                <div class="w-16 h-16 rounded-full bg-[#4caf50] text-white text-2xl flex items-center justify-center mx-auto mb-6">
                  ‚úì
                </div>
                <h3 class="m-0 mb-4 text-xl font-semibold text-[#333] dark:text-[#eee]">
                  Ready to Push
                </h3>
                <p class="text-[#666] dark:text-[#aaa] leading-relaxed mb-8">
                  Your changes are ready to be committed and pushed to the remote
                  repository. This will trigger an Amplify deployment with the
                  updated runtime configuration.
                </p>
                <button
                  class="bg-[#4caf50] text-white border-none px-8 py-3.5 rounded-md text-base font-semibold cursor-pointer transition-all duration-200 hover:bg-[#45a049] shadow-md hover:shadow-lg active:transform active:scale-95"
                  onClick={handleInitiatePush}
                >
                  Push Changes
                </button>
              </div>
            </Show>

            <Show when={pushStatus() === "confirming"}>
              <div class="text-center max-w-[500px]">
                <div class="w-16 h-16 rounded-full bg-[#ff9800] text-white text-2xl flex items-center justify-center mx-auto mb-6">
                  ‚ö†Ô∏è
                </div>
                <h3 class="m-0 mb-4 text-xl font-semibold text-[#333] dark:text-[#eee]">
                  Confirm Push
                </h3>
                <p class="text-[#666] dark:text-[#aaa] leading-relaxed mb-8">
                  Are you sure you want to push these changes? This will commit and
                  push to the{" "}
                  <strong class="text-[#333] dark:text-[#eee] font-bold">
                    {appState.amplifyResources.selectedBranch?.branch_name}
                  </strong>{" "}
                  branch and trigger an Amplify deployment.
                </p>
                <div class="flex justify-center gap-4">
                  <button
                    class="bg-transparent text-[#666] dark:text-[#aaa] border border-[#ccc] dark:border-[#555] px-6 py-3 rounded-md font-semibold cursor-pointer transition-all duration-200 hover:bg-[#f5f5f5] dark:hover:bg-[#333]"
                    onClick={handleCancelPush}
                  >
                    Cancel
                  </button>
                  <button
                    class="bg-[#4caf50] text-white border-none px-6 py-3 rounded-md font-semibold cursor-pointer transition-all duration-200 hover:bg-[#45a049]"
                    onClick={handleConfirmPush}
                  >
                    Confirm & Push
                  </button>
                </div>
              </div>
            </Show>

            <Show when={pushStatus() === "running"}>
              <div class="text-center max-w-[500px]">
                <span class="w-10 h-10 border-4 border-[#e0e0e0] border-t-[#396cd8] rounded-full animate-spin inline-block mb-4"></span>
                <h3 class="m-0 mb-2 text-xl font-semibold text-[#333] dark:text-[#eee]">
                  Pushing Changes...
                </h3>
                <p class="text-[#666] dark:text-[#aaa] m-0">
                  Committing and pushing to remote repository
                </p>
              </div>
            </Show>

            <Show when={pushStatus() === "success"}>
              <div
                class={`text-center p-8 rounded-lg border transition-all duration-200 w-full ${commitHash() ? "bg-[#f0f8f0] border-[#4caf50] dark:bg-[#1a2a1a]" : "bg-[#fff8f0] border-[#f57c00] dark:bg-[#3a2a1a]"}`}
              >
                <Show when={commitHash()}>
                  <div class="w-16 h-16 rounded-full bg-[#4caf50] text-white text-2xl flex items-center justify-center mx-auto mb-6">
                    ‚úì
                  </div>
                  <h3 class="text-[#15803d] dark:text-[#66bb6a] text-xl font-semibold m-4">
                    Successfully Pushed!
                  </h3>
                </Show>
                <Show when={!commitHash()}>
                  <div class="w-16 h-16 rounded-full bg-[#f57c00] text-white text-2xl font-bold flex items-center justify-center mx-auto mb-6">
                    ‚ö†Ô∏è
                  </div>
                  <h3 class="text-[#e65100] dark:text-[#ffb74d] text-xl font-semibold m-4">
                    Push Skipped
                  </h3>
                </Show>
                <Show when={commitHash()}>
                  <div class="flex items-center justify-center gap-2 mb-6 p-3 bg-white/50 dark:bg-[#333]/50 rounded-md border border-black/5 dark:border-white/5">
                    <span class="text-[0.85rem] text-[#666] dark:text-[#aaa] font-medium">
                      Commit:
                    </span>
                    <code class="font-mono text-[0.85rem] bg-[#e0e0e0] dark:bg-[#444] px-2 py-1 rounded text-[#333] dark:text-[#eee]">
                      {commitHash()}
                    </code>
                  </div>
                </Show>

                {/* Amplify Job Status */}
                <Show when={amplifyJob()}>
                  <div class="mt-6 p-4 bg-[#f8f9fa] dark:bg-[#333] rounded-lg border border-[#e9ecef] dark:border-[#444] text-left">
                    <h4 class="m-0 mb-4 text-[#495057] dark:text-[#eee] text-base font-semibold">
                      Amplify Deployment Job
                    </h4>
                    <div class="flex flex-col gap-3">
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-[#6c757d] dark:text-[#aaa] text-[0.875rem] min-w-[80px]">
                          Job ID:
                        </span>
                        <code class="font-mono text-[0.85rem] bg-[#e0e0e0] dark:bg-[#444] px-2 py-1 rounded text-[#333] dark:text-[#eee]">
                          {amplifyJob()?.jobId}
                        </code>
                      </div>
                      <div class="flex items-center gap-2">
                        <span class="font-medium text-[#6c757d] dark:text-[#aaa] text-[0.875rem] min-w-[80px]">
                          Status:
                        </span>
                        <div class="flex items-center gap-2">
                          <span
                            class={`px-3 py-1 rounded-md text-sm font-semibold ${amplifyJob()?.status.toLowerCase() === "succeed"
                              ? "bg-[#d4edda] text-[#155724] dark:bg-[#1b3a24] dark:text-[#81c784]"
                              : amplifyJob()?.status.toLowerCase() === "failed"
                                ? "bg-[#f8d7da] text-[#721c24] dark:bg-[#4a1f1f] dark:text-[#e57373]"
                                : amplifyJob()?.status.toLowerCase() === "running"
                                  ? "bg-[#d1ecf1] text-[#0c5460] dark:bg-[#1a2e3a] dark:text-[#7dd3fc]"
                                  : "bg-[#e2e3e5] text-[#383d41] dark:bg-[#3a3a3a] dark:text-[#aaa]"
                              }`}
                          >
                            {amplifyJob()?.status}
                          </span>
                          <Show when={amplifyJob()?.status === "RUNNING"}>
                            <span class="w-3 h-3 border-2 border-[#e0f2fe] border-t-[#0ea5e9] rounded-full animate-spin"></span>
                          </Show>
                        </div>
                      </div>
                      <Show when={amplifyJob()?.startTime}>
                        <div class="flex items-center gap-2">
                          <span class="font-medium text-[#6c757d] dark:text-[#aaa] text-[0.875rem] min-w-[80px]">
                            Started:
                          </span>
                          <span class="text-[#495057] dark:text-[#eee] text-[0.875rem]">
                            {formatLocalDateTime(
                              amplifyJob()!.startTime!.toISOString(),
                            )}
                          </span>
                        </div>
                      </Show>
                      <Show when={amplifyJob()?.endTime}>
                        <div class="flex items-center gap-2">
                          <span class="font-medium text-[#6c757d] dark:text-[#aaa] text-[0.875rem] min-w-[80px]">
                            Ended:
                          </span>
                          <span class="text-[#495057] dark:text-[#eee] text-[0.875rem]">
                            {formatLocalDateTime(
                              amplifyJob()!.endTime!.toISOString(),
                            )}
                          </span>
                        </div>
                      </Show>
                    </div>
                  </div>
                </Show>

                <Show when={jobCheckError() && !commitHash()}>
                  <div class="mt-4 text-[#0066cc] dark:text-[#7dd3fc]">
                    <p class="flex items-center justify-center gap-2 text-sm italic">
                      <Show when={checkingForJob()}>
                        <span class="w-3 h-3 border-2 border-[#e0f2fe] border-t-[#0ea5e9] rounded-full animate-spin"></span>
                      </Show>
                      {jobCheckError()}
                    </p>
                  </div>
                </Show>

                <Show when={jobCheckError() && commitHash()}>
                  <div class="mt-4 text-[#f57c00] dark:text-[#ffb74d]">
                    <p class="flex items-center justify-center gap-2 text-sm italic">
                      <Show when={checkingForJob()}>
                        <span class="w-3 h-3 border-2 border-[#fff7ed] border-t-[#f97316] rounded-full animate-spin"></span>
                      </Show>
                      {jobCheckError()}
                    </p>
                  </div>
                </Show>

                {/* Environment Variable Changes */}
                <Show when={getEnvVarChanges().length > 0}>
                  <div class="mt-6 p-4 bg-[#f8f9fa] dark:bg-[#333] rounded-lg border border-[#e9ecef] dark:border-[#444] text-left">
                    <h4 class="m-0 mb-4 text-[#495057] dark:text-[#eee] text-base font-semibold">
                      Environment Variable Changes
                    </h4>
                    <div class="flex flex-col gap-2 mb-4">
                      <For each={getEnvVarChanges()}>
                        {(change) => (
                          <div class="p-3 bg-white dark:bg-[#444] rounded-md border border-[#dee2e6] dark:border-[#555]">
                            <div class="flex flex-wrap items-center gap-2 text-[0.875rem]">
                              <span class="px-2 py-0.5 bg-[#6c757d] text-white rounded text-[0.75rem] font-medium uppercase">
                                {change.level.toUpperCase()}:
                              </span>
                              <code class="font-mono bg-[#e9ecef] dark:bg-[#555] px-1.5 py-0.5 rounded text-[#495057] dark:text-[#ddd]">
                                {change.key}
                              </code>
                              <Show when={change.old_value && change.new_value}>
                                <span class="px-2 py-0.5 bg-[#007bff] text-white rounded text-[0.75rem] font-medium">
                                  updated
                                </span>
                                <span class="flex items-center gap-1 flex-wrap">
                                  <span class="font-mono bg-[#f8d7da] text-[#721c24] px-1.5 py-0.5 rounded dark:bg-[#4a1f1f] dark:text-[#e57373]">
                                    {change.old_value}
                                  </span>
                                  <span class="text-[#6c757d] dark:text-[#aaa] font-bold">
                                    ‚Üí
                                  </span>
                                  <span class="font-mono bg-[#d4edda] text-[#155724] px-1.5 py-0.5 rounded dark:bg-[#1b3a24] dark:text-[#81c784]">
                                    {change.new_value}
                                  </span>
                                </span>
                              </Show>
                              <Show when={change.old_value && !change.new_value}>
                                <span class="px-2 py-0.5 bg-[#dc3545] text-white rounded text-[0.75rem] font-medium">
                                  removed
                                </span>
                                <span class="font-mono bg-[#f8d7da] text-[#721c24] px-1.5 py-0.5 rounded dark:bg-[#4a1f1f] dark:text-[#e57373]">
                                  was: {change.old_value}
                                </span>
                              </Show>
                              <Show when={!change.old_value && change.new_value}>
                                <span class="px-2 py-0.5 bg-[#28a745] text-white rounded text-[0.75rem] font-medium">
                                  added
                                </span>
                                <span class="font-mono bg-[#d4edda] text-[#155724] px-1.5 py-0.5 rounded dark:bg-[#1b3a24] dark:text-[#81c784]">
                                  {change.new_value}
                                </span>
                              </Show>
                            </div>
                          </div>
                        )}
                      </For>
                    </div>
                    <Show
                      when={
                        getEnvVarChanges().filter(
                          (c) =>
                            c.key !== "_LIVE_UPDATES" && c.key !== "_CUSTOM_IMAGE",
                        ).length > 0
                      }
                    >
                      <button
                        class="px-4 py-2 bg-[#ffc107] text-[#212529] border-none rounded-md text-[0.875rem] font-medium cursor-pointer transition-all duration-200 hover:bg-[#e0a800] hover:-translate-y-0.5"
                        onClick={() => setShowRevertDialog(true)}
                      >
                        Revert Environment Variables
                      </button>
                      <p class="mt-2 text-[0.75rem] text-[#6c757d] dark:text-[#aaa] italic">
                        Note: _LIVE_UPDATES and _CUSTOM_IMAGE changes cannot be
                        reverted
                      </p>
                    </Show>
                  </div>
                </Show>

                {/* Build Config Changes */}
                <Show
                  when={
                    appState.repository.buildConfigChange &&
                    appState.repository.buildConfigChange.location === "Cloud"
                  }
                >
                  <div class="mt-6 p-4 bg-[#f8f9fa] dark:bg-[#333] rounded-lg border border-[#e9ecef] dark:border-[#444] text-left">
                    <h4 class="m-0 mb-4 text-[#495057] dark:text-[#eee] text-base font-semibold">
                      Build Configuration Changes
                    </h4>
                    <div class="p-3 bg-white dark:bg-[#444] rounded-md border border-[#dee2e6] dark:border-[#555] mb-4">
                      <div class="flex items-center gap-2 mb-3">
                        <span class="font-medium text-[#6c757d] dark:text-[#aaa] text-[0.875rem]">
                          Location:
                        </span>
                        <span class="text-[#495057] dark:text-[#eee] text-[0.875rem]">
                          Cloud (AWS Amplify buildSpec)
                        </span>
                      </div>
                      <div class="flex flex-col gap-2">
                        <div class="flex flex-col gap-1">
                          <span class="font-medium text-[#6c757d] dark:text-[#aaa] text-[0.875rem]">
                            Old Command:
                          </span>
                          <code class="font-mono text-[0.8rem] p-2 rounded block break-all bg-[#f8d7da] text-[#721c24] border border-[#f5c6cb] dark:bg-[#4a1f1f] dark:text-[#e57373] dark:border-[#4a1f1f]">
                            {appState.repository.buildConfigChange?.old_command}
                          </code>
                        </div>
                        <span class="text-[#6c757d] dark:text-[#aaa] font-bold text-center my-1 select-none">
                          ‚Üì
                        </span>
                        <div class="flex flex-col gap-1">
                          <span class="font-medium text-[#6c757d] dark:text-[#aaa] text-[0.875rem]">
                            New Command:
                          </span>
                          <code class="font-mono text-[0.8rem] p-2 rounded block break-all bg-[#d4edda] text-[#155724] border border-[#c3e6cb] dark:bg-[#1b3a24] dark:text-[#81c784] dark:border-[#1b3a24]">
                            {appState.repository.buildConfigChange?.new_command}
                          </code>
                        </div>
                      </div>
                    </div>
                    <button
                      class="px-4 py-2 bg-[#ffc107] text-[#212529] border-none rounded-md text-[0.875rem] font-medium cursor-pointer transition-all duration-200 hover:bg-[#e0a800] hover:-translate-y-0.5"
                      onClick={() => setShowBuildSpecRevertDialog(true)}
                    >
                      Revert Build Configuration
                    </button>
                    <p class="mt-2 text-[0.75rem] text-[#6c757d] dark:text-[#aaa] italic">
                      This will restore the original buildSpec in AWS Amplify
                    </p>
                  </div>
                </Show>

                {/* Successful Push with commit (Standard or Test) */}
                <Show when={commitHash()}>
                  <div class="mt-6 p-4 bg-[#e8f5e9] dark:bg-[#1a2e1a] rounded-lg text-left">
                    <p class="m-0 mb-3 font-semibold text-[#2e7d32] dark:text-[#66bb6a]">
                      Next Steps:
                    </p>
                    <ul class="m-0 pl-6 text-[#666] dark:text-[#aaa] leading-relaxed list-disc">
                      <li class="mb-2">
                        Monitor the deployment in the{" "}
                        <a
                          href={`https://${appState.awsConfig.selectedRegion}.console.aws.amazon.com/amplify/apps/${appState.amplifyResources.selectedApp?.app_id}/branches/${targetBranch() || appState.amplifyResources.selectedBranch?.branch_name}/deployments`}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="text-[#396cd8] dark:text-[#5c8ce6] font-medium hover:underline"
                        >
                          AWS Amplify Console
                        </a>
                      </li>
                      <li>
                        Verify Lambda functions are using the new runtime after
                        deployment completes
                      </li>
                    </ul>
                  </div>

                  {/* Waiting for job completion message for test branches */}
                  <Show when={deploymentMode() === "test" && amplifyJob() && !["SUCCEED", "FAILED", "CANCELLED"].includes(amplifyJob()!.status)}>
                    <div class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                      <div class="flex items-center gap-3">
                        <span class="w-5 h-5 border-2 border-blue-200 border-t-blue-500 rounded-full animate-spin"></span>
                        <div>
                          <p class="m-0 text-sm font-medium text-blue-700 dark:text-blue-300">
                            Waiting for deployment to complete...
                          </p>
                          <p class="m-0 mt-1 text-xs text-blue-600 dark:text-blue-400">
                            The Next button will be enabled once the Amplify job finishes.
                          </p>
                        </div>
                      </div>
                    </div>
                  </Show>
                </Show>

                {/* No changes (Standard branch flow) */}
                <Show when={!commitHash()}>
                  <div class="mt-6 p-4 bg-[#e8f5e9] dark:bg-[#1a2e1a] rounded-lg text-left">
                    {/* Show "What happened" only if no job is being tracked */}
                    <Show when={!amplifyJob()}>
                      <p class="m-0 mb-3 font-semibold text-[#2e7d32] dark:text-[#66bb6a]">
                        What happened:
                      </p>
                      <ul class="m-0 pl-6 text-[#666] dark:text-[#aaa] leading-relaxed list-disc">
                        <li class="mb-1">
                          All runtime configurations were already up to date
                        </li>
                        <li class="mb-1">
                          Environment variables were updated as needed
                        </li>
                        <li>
                          No file changes were required, so no commit was created
                        </li>
                      </ul>
                      <Show when={lastFailedJob()}>
                        <Show when={lastFailedJob()?.status === "FAILED"}>
                          <div class="mt-4 p-4 bg-[#fff3cd] dark:bg-[#3a2e1a] border border-[#ffc107] dark:border-[#f57c00] rounded-lg">
                            <p class="m-0 mb-3 text-[#856404] dark:text-[#ffb74d] text-sm leading-relaxed">
                              <strong class="font-bold">Note:</strong> The last
                              deployment job (ID: {lastFailedJob()?.jobId}) failed.
                              This might be why your Lambda functions haven't been
                              updated yet.
                            </p>
                            <div class="flex flex-wrap gap-3">
                              <button
                                class="px-4 py-2 bg-[#ff9800] text-white border-none rounded-md text-sm font-medium cursor-pointer transition-all duration-200 hover:bg-[#f57c00] disabled:opacity-60 disabled:cursor-not-allowed shadow-sm"
                                onClick={handleRetryJob}
                                disabled={retryingJob()}
                              >
                                {retryingJob()
                                  ? "Retrying Job..."
                                  : "Retry Failed Deployment"}
                              </button>
                              <a
                                href={`https://${appState.awsConfig.selectedRegion}.console.aws.amazon.com/amplify/apps/${appState.amplifyResources.selectedApp?.app_id}/branches/${appState.amplifyResources.selectedBranch?.branch_name}/deployments`}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="px-4 py-2 bg-[#396cd8] text-white rounded-md text-sm font-medium transition-all duration-200 hover:bg-[#2563eb] shadow-sm"
                              >
                                View in AWS Console
                              </a>
                            </div>
                          </div>
                        </Show>
                        <Show when={lastFailedJob()?.status === "SUCCEED"}>
                          <div class="mt-4 p-4 bg-[#fff3cd] dark:bg-[#3a2e1a] border border-[#ffc107] dark:border-[#f57c00] rounded-lg text-left">
                            <p class="m-0 mb-3 text-[#856404] dark:text-[#ffb74d] text-sm leading-relaxed">
                              <strong class="font-bold">Note:</strong> The last
                              deployment job (ID: {lastFailedJob()?.jobId})
                              succeeded, but your Lambda functions might have been
                              updated outside of Amplify after that deployment. You
                              can trigger a new deployment to ensure the runtime
                              configurations are applied.
                            </p>
                            <button
                              class="px-4 py-2 bg-[#ff9800] text-white border-none rounded-md text-sm font-medium cursor-pointer transition-all duration-200 hover:bg-[#f57c00] disabled:opacity-60 disabled:cursor-not-allowed shadow-sm"
                              onClick={handleRetryJob}
                              disabled={retryingJob()}
                            >
                              {retryingJob()
                                ? "Starting Deployment..."
                                : "Trigger New Deployment"}
                            </button>
                          </div>
                        </Show>
                      </Show>
                      <Show when={!lastFailedJob()}>
                        <p class="mt-4 p-3 bg-[#e7f3ff] dark:bg-[#1a2a3a] border border-[#b3d9ff] dark:border-[#396cd8] rounded-md text-[#0066cc] dark:text-[#7dd3fc] text-sm italic">
                          Since no code changes were made, your Lambda functions
                          should already be using the correct runtime versions.
                        </p>
                      </Show>
                    </Show>

                    {/* Show "Next Steps" if a job is being tracked (after retry) */}
                    <Show when={amplifyJob()}>
                      <p class="m-0 mb-3 font-semibold text-[#2e7d32] dark:text-[#66bb6a]">
                        Next Steps:
                      </p>
                      <ul class="m-0 pl-6 text-[#666] dark:text-[#aaa] leading-relaxed list-disc">
                        <li class="mb-2">
                          Monitor the deployment in the{" "}
                          <a
                            href={`https://${appState.awsConfig.selectedRegion}.console.aws.amazon.com/amplify/apps/${appState.amplifyResources.selectedApp?.app_id}/branches/${targetBranch() || appState.amplifyResources.selectedBranch?.branch_name}/deployments`}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-[#396cd8] dark:text-[#5c8ce6] font-medium hover:underline"
                          >
                            AWS Amplify Console
                          </a>
                        </li>
                        <li>
                          Verify Lambda functions are using the new runtime after
                          deployment completes
                        </li>
                      </ul>
                    </Show>
                  </div>
                </Show>
              </div>
            </Show>

            <Show when={pushStatus() === "failed"}>
              <div class="text-center max-w-[600px]">
                <div class="w-16 h-16 rounded-full bg-[#f44336] text-white text-2xl flex items-center justify-center mx-auto mb-6">
                  ‚úó
                </div>
                <h3 class="m-0 mb-4 text-[#c62828] dark:text-[#ef5350] text-xl font-semibold">
                  Push Failed
                </h3>
                <div class="bg-[#ffebee] dark:bg-[#3a1a1a] p-4 rounded-lg text-left mb-4 overflow-hidden">
                  <pre class="m-0 font-mono text-[0.85rem] text-[#c62828] dark:text-[#ff6b6b] whitespace-pre-wrap break-words">
                    {pushError()}
                  </pre>
                </div>
                <p class="text-[#666] dark:text-[#aaa] text-[0.9rem] leading-relaxed mb-6">
                  Common issues: authentication problems, network errors, or
                  conflicts with remote branch. Ensure you have push access to the
                  repository.
                </p>
                <button
                  class="bg-[#396cd8] text-white border-none px-6 py-2.5 rounded-md text-[0.95rem] font-medium cursor-pointer transition-all duration-200 hover:bg-[#2563eb]"
                  onClick={handleInitiatePush}
                >
                  Retry Push
                </button>
              </div>
            </Show>
          </OperationCard>
        </Show>
      </div>

      {/* Revert Environment Variables Dialog */}
      <Show when={showRevertDialog()}>
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-[1000]">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-100 dark:border-blue-800 text-blue-700 dark:text-blue-300">
              <p class="m-0 text-sm leading-relaxed">
                You've successfully deployed to the test branch <strong>{targetBranch()}</strong>.
                How would you like to proceed with the changes?
              </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <button
                class={`p-6 rounded-xl border-2 text-left transition-all duration-200 cursor-pointer ${postTestSelection() === "push"
                  ? "border-blue-500 bg-blue-50 dark:bg-blue-900/30 ring-2 ring-blue-500/20"
                  : "border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:border-gray-300 dark:hover:border-gray-600"
                  }`}
                onClick={() => setPostTestSelection("push")}
              >
                <div class="flex items-center gap-3 mb-3">
                  <span class="text-2xl">üöÄ</span>
                  <h4 class="m-0 text-lg font-semibold text-gray-900 dark:text-white">Push to Current</h4>
                </div>
                <p class="m-0 text-sm text-gray-600 dark:text-gray-400 leading-relaxed">
                  Automatically push the verified changes from the test branch to your main branch (<strong>{appState.amplifyResources.selectedBranch?.branch_name}</strong>).
                </p>
              </button>

              <button
                class={`p-6 rounded-xl border-2 text-left transition-all duration-200 cursor-pointer ${postTestSelection() === "manual"
                  ? "border-blue-500 bg-blue-50 dark:bg-blue-900/30 ring-2 ring-blue-500/20"
                  : "border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:border-gray-300 dark:hover:border-gray-600"
                  }`}
                onClick={() => setPostTestSelection("manual")}
              >
                <div class="flex items-center gap-3 mb-3">
                  <span class="text-2xl">üìù</span>
                  <h4 class="m-0 text-lg font-semibold text-gray-900 dark:text-white">Manual Merge</h4>
                </div>
                <p class="m-0 text-sm text-gray-600 dark:text-gray-400 leading-relaxed">
                  You will handle the merge manually through your Git provider. No further actions will be taken here.
                </p>
              </button>
            </div>
          </div>
        </Show>

        <Show when={innerStep() === 2}>
          {/* Inner Step 2: Final Push to Current Branch */}
          <div class="space-y-6">
            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-100 dark:border-blue-800 text-blue-700 dark:text-blue-300">
              <p class="m-0 text-sm leading-relaxed">
                Merging and pushing changes from <strong>{targetBranch()}</strong> to <strong>{appState.amplifyResources.selectedBranch?.branch_name}</strong>.
              </p>
            </div>

            <div class="bg-white dark:bg-gray-800 p-8 rounded-xl border border-gray-200 dark:border-gray-700 min-h-[300px] flex items-center justify-center">
              <Show when={managementLoading()}>
                <div class="text-center max-w-[500px]">
                  <div class="w-16 h-16 border-4 border-blue-100 border-t-blue-500 rounded-full animate-spin mx-auto mb-6"></div>
                  <h3 class="m-0 mb-4 text-xl font-semibold text-gray-900 dark:text-white">
                    Deploying to {appState.amplifyResources.selectedBranch?.branch_name}...
                  </h3>
                  <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-dashed border-gray-300 dark:border-gray-600">
                    <pre class="m-0 text-xs text-gray-600 dark:text-gray-400 font-mono whitespace-pre-wrap">
                      {managementStatus() || "Preparing to push..."}
                    </pre>
                  </div>
                </div>
              </Show>

              <Show when={!managementLoading() && !managementStatus()}>
                <div class="text-center max-w-[500px]">
                  <div class="w-16 h-16 rounded-full bg-blue-500 text-white text-2xl flex items-center justify-center mx-auto mb-6">
                    üöÄ
                  </div>
                  <h3 class="m-0 mb-4 text-xl font-semibold text-gray-900 dark:text-white">
                    Ready to Deploy
                  </h3>
                  <p class="text-gray-600 dark:text-gray-400 leading-relaxed mb-8">
                    Click the button below to merge and push your changes to the main branch.
                  </p>
                  <button
                    class="bg-blue-500 text-white border-none px-8 py-3.5 rounded-md text-base font-semibold cursor-pointer transition-all duration-200 hover:bg-blue-600 shadow-md hover:shadow-lg active:transform active:scale-95"
                    onClick={handlePushToCurrent}
                  >
                    Push to {appState.amplifyResources.selectedBranch?.branch_name}
                  </button>
                </div>
              </Show>

              <Show when={!managementLoading() && managementStatus()?.includes("Successfully")}>
                <div class="text-center max-w-[500px]">
                  <div class="w-16 h-16 rounded-full bg-green-500 text-white text-2xl flex items-center justify-center mx-auto mb-6">
                    ‚úì
                  </div>
                  <h3 class="m-0 mb-4 text-xl font-semibold text-green-700 dark:text-green-400">
                    Successfully Deployed!
                  </h3>
                  <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                    <p class="m-0 text-sm text-green-700 dark:text-green-300">
                      {managementStatus()}
                    </p>
                  </div>
                  <p class="mt-4 text-gray-600 dark:text-gray-400 text-sm">
                    Click Next to proceed to cleanup options.
                  </p>
                </div>
              </Show>

              <Show when={!managementLoading() && managementStatus()?.includes("Error")}>
                <div class="text-center max-w-[500px]">
                  <div class="w-16 h-16 rounded-full bg-red-500 text-white text-2xl flex items-center justify-center mx-auto mb-6">
                    ‚úó
                  </div>
                  <h3 class="m-0 mb-4 text-xl font-semibold text-red-700 dark:text-red-400">
                    Deployment Failed
                  </h3>
                  <div class="p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
                    <pre class="m-0 text-sm text-red-700 dark:text-red-300 whitespace-pre-wrap font-mono">
                      {managementStatus()}
                    </pre>
                  </div>
                  <button
                    class="mt-6 bg-blue-500 text-white border-none px-6 py-2.5 rounded-md text-sm font-semibold cursor-pointer transition-all duration-200 hover:bg-blue-600"
                    onClick={handlePushToCurrent}
                  >
                    Retry Push
                  </button>
                </div>
              </Show>
            </div>
          </div>
        </Show>

        <Show when={innerStep() === 3}>
          {/* Inner Step 3: Cleanup & Finish */}
          <div class="space-y-6">
            <div class="text-center py-4">
              <div class="w-16 h-16 bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                ‚úì
              </div>
              <h3 class="m-0 text-xl font-semibold text-gray-900 dark:text-white">
                Deployment Complete!
              </h3>
              <p class="mt-2 text-gray-600 dark:text-gray-400">
                <Show when={postTestSelection() === "push"}>
                  Your changes have been successfully deployed to <strong>{appState.amplifyResources.selectedBranch?.branch_name}</strong>.
                </Show>
                <Show when={postTestSelection() === "manual"}>
                  Your test deployment is complete. You can now merge manually through your Git provider.
                </Show>
              </p>
            </div>

            <Show when={targetBranch()}>
              <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
                <h4 class="m-0 mb-4 text-gray-900 dark:text-white font-semibold flex items-center gap-2">
                  <span class="text-lg">üßπ</span> Optional: Clean Up Test Branch
                </h4>
                <p class="m-0 mb-6 text-sm text-gray-600 dark:text-gray-400 leading-relaxed">
                  The test branch <code class="px-2 py-1 bg-gray-200 dark:bg-gray-700 rounded font-mono text-xs">{targetBranch()}</code> is no longer needed. 
                  You can delete it locally, remotely, and in AWS Amplify, or keep it for reference.
                </p>

                <Show when={managementStatus()?.includes("deleted successfully")}>
                  <div class="p-3 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 text-sm rounded mb-4 border border-green-200 dark:border-green-800">
                    ‚úì Test branch has been successfully deleted.
                  </div>
                </Show>

                <Show when={!managementStatus()?.includes("deleted successfully")}>
                  <button
                    class="px-6 py-2.5 bg-red-500 text-white border-none rounded-md text-sm font-semibold cursor-pointer transition-all duration-200 hover:bg-red-600 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm"
                    onClick={handleDeleteTestBranch}
                    disabled={managementLoading()}
                  >
                    {managementLoading() ? "Deleting Branch..." : "Delete Test Branch"}
                  </button>
                </Show>

                <Show when={managementStatus() && !managementStatus()?.includes("deleted successfully") && !managementStatus()?.includes("Successfully pushed")}>
                  <div class="mt-4 p-3 bg-gray-100 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700">
                    <p class="m-0 text-xs font-mono text-gray-600 dark:text-gray-400 whitespace-pre-wrap">
                      {managementStatus()}
                    </p>
                  </div>
                </Show>
              </div>
            </Show>

            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-100 dark:border-blue-800">
              <p class="m-0 text-sm text-blue-700 dark:text-blue-300 leading-relaxed">
                <strong>Next Steps:</strong> Monitor your deployment in the{" "}
                <a
                  href={`https://${appState.awsConfig.selectedRegion}.console.aws.amazon.com/amplify/apps/${appState.amplifyResources.selectedApp?.app_id}/branches/${appState.amplifyResources.selectedBranch?.branch_name}/deployments`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-blue-600 dark:text-blue-400 font-medium hover:underline"
                >
                  AWS Amplify Console
                </a>{" "}
                and verify Lambda functions are using the new runtime.
              </p>
            </div>

            <div class="text-center pt-4">
              <p class="text-gray-600 dark:text-gray-400 text-sm">
                Click Finish to complete the wizard.
              </p>
            </div>
          </div>
        </Show>
      </div>

      {/* Revert Environment Variables Dialog */}
      <Show when={showRevertDialog()}>
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-[1000]">
          <div class="bg-white dark:bg-[#2a2a2a] rounded-xl p-6 max-w-[500px] w-[90%] max-h-[80vh] overflow-y-auto shadow-2xl">
            <h3 class="m-0 mb-4 text-[#495057] dark:text-[#eee] text-xl font-semibold">
              Revert Environment Variables
            </h3>
            <p class="m-0 mb-4 text-[#6c757d] dark:text-[#aaa] leading-relaxed">
              Are you sure you want to revert the environment variable changes?
              This will restore the original values.
            </p>
            <div class="flex flex-col gap-2 mb-6 max-h-[200px] overflow-y-auto pr-1">
              <For
                each={getEnvVarChanges().filter(
                  (c) => c.key !== "_LIVE_UPDATES" && c.key !== "_CUSTOM_IMAGE",
                )}
              >
                {(change) => (
                  <div class="flex items-center gap-2 p-2 bg-[#f8f9fa] dark:bg-[#333] rounded-md text-[0.875rem]">
                    <span class="px-2 py-0.5 bg-[#6c757d] text-white rounded text-[0.75rem] font-medium uppercase">
                      {change.level}
                    </span>
                    <code class="font-mono bg-white dark:bg-[#444] px-1.5 py-0.5 rounded text-[#495057] dark:text-[#ddd]">
                      {change.key}
                    </code>
                    <span class="text-[#ffc107] font-bold">‚Üê</span>
                    <span class="text-[#28a745] dark:text-[#81c784] font-mono bg-[#d4edda] dark:bg-[#1b3a24] px-1.5 py-0.5 rounded">
                      {change.old_value}
                    </span>
                  </div>
                )}
              </For>
            </div>
            <div class="flex justify-end gap-3">
              <button
                class="px-4 py-2 bg-[#6c757d] text-white border-none rounded-md text-sm cursor-pointer transition-all duration-200 hover:bg-[#5a6268] disabled:opacity-60 disabled:cursor-not-allowed"
                onClick={handleCancelRevert}
                disabled={revertInProgress()}
              >
                Cancel
              </button>
              <button
                class="px-4 py-2 bg-[#ffc107] text-[#212529] border-none rounded-md text-sm font-medium cursor-pointer transition-all duration-200 hover:bg-[#e0a800] disabled:opacity-60 disabled:cursor-not-allowed"
                onClick={handleRevertEnvVars}
                disabled={revertInProgress()}
              >
                {revertInProgress() ? "Reverting..." : "Confirm Revert"}
              </button>
            </div>
          </div>
        </div>
      </Show>

      {/* Build Spec Revert Confirmation Dialog */}
      <Show when={showBuildSpecRevertDialog()}>
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-[1000]">
          <div class="bg-white dark:bg-[#2a2a2a] rounded-xl p-6 max-w-[500px] w-[90%] max-h-[80vh] overflow-y-auto shadow-2xl">
            <h3 class="m-0 mb-4 text-[#495057] dark:text-[#eee] text-xl font-semibold">
              Revert Build Configuration
            </h3>
            <p class="m-0 mb-4 text-[#6c757d] dark:text-[#aaa] leading-relaxed">
              Are you sure you want to revert the build configuration changes?
              This will restore the original buildSpec in AWS Amplify.
            </p>
            <div class="flex flex-col gap-2 mb-6">
              <Show when={appState.repository.buildConfigChange}>
                <div class="flex items-center gap-2 p-2 bg-[#f8f9fa] dark:bg-[#333] rounded-md text-[0.875rem]">
                  <span class="px-2 py-0.5 bg-[#6c757d] text-white rounded text-[0.75rem] font-medium uppercase">
                    cloud
                  </span>
                  <code class="font-mono bg-white dark:bg-[#444] px-1.5 py-0.5 rounded text-[#495057] dark:text-[#ddd]">
                    Build Command
                  </code>
                  <span class="text-[#ffc107] font-bold">‚Üê</span>
                  <span class="text-[#28a745] dark:text-[#81c784] font-mono bg-[#d4edda] dark:bg-[#1b3a24] px-1.5 py-0.5 rounded">
                    {appState.repository.buildConfigChange?.old_command}
                  </span>
                </div>
              </Show>
            </div>
            <div class="flex justify-end gap-3">
              <button
                class="px-4 py-2 bg-[#6c757d] text-white border-none rounded-md text-sm cursor-pointer transition-all duration-200 hover:bg-[#5a6268] disabled:opacity-60 disabled:cursor-not-allowed"
                onClick={handleCancelBuildSpecRevert}
                disabled={revertBuildSpecInProgress()}
              >
                Cancel
              </button>
              <button
                class="px-4 py-2 bg-[#ffc107] text-[#212529] border-none rounded-md text-sm font-medium cursor-pointer transition-all duration-200 hover:bg-[#e0a800] disabled:opacity-60 disabled:cursor-not-allowed"
                onClick={handleRevertBuildSpec}
                disabled={revertBuildSpecInProgress()}
              >
                {revertBuildSpecInProgress()
                  ? "Reverting..."
                  : "Confirm Revert"}
              </button>
            </div>
          </div>
        </div>
      </Show>
    </WizardStep>
  );
}

export default PushStep;
